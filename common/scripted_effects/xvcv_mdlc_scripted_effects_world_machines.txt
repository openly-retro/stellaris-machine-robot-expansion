# XVCV Scripted effects

# There's a bug where clearing all deposits doesn't work on the first try
# Take CUSTOM_DEPOSIT_TYPE arg
oxr_mdlc_planet_clear_all_custom_deposits_of_type = {
	optimize_memory
	export_trigger_value_to_variable = {
		trigger = count_deposits
		parameters = { type = $CUSTOM_DEPOSIT_TYPE$ }
		variable = xvcv_mdlc_num_existing_offsets_of_type_custom
	}
	while = {
		limit = {
			check_variable = {
				which = xvcv_mdlc_num_existing_offsets_of_type_custom
				value > 0
			}
		}
		every_deposit = { limit = { is_deposit_type = $CUSTOM_DEPOSIT_TYPE$ } remove_deposit = yes }
		export_trigger_value_to_variable = {
			trigger = count_deposits
			parameters = { type = $CUSTOM_DEPOSIT_TYPE$ }
			variable = xvcv_mdlc_num_existing_offsets_of_type_custom
		}
	}
}

# Specific effect for converting existing worlds to Auto-Machine Worlds
xvcv_mdlc_planet_decision_machine_world_automation_effect = {

	set_variable = { which = xvcv_mdlc_pc_machine_auto_district_city_var value = 0 }
	set_variable = { which = xvcv_mdlc_pc_machine_auto_district_generator_var value = 0 }
	set_variable = { which = xvcv_mdlc_pc_machine_auto_district_mining_var value = 0 }
	set_variable = { which = xvcv_mdlc_pc_machine_auto_district_farming_var value = 0 }
	if = {
		limit = { is_planet_class = pc_machine }
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_nexus }
			variable = xvcv_mdlc_pc_machine_auto_district_city_var
		}
		# Generators
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_nexus_1 }
			variable = xvcv_mdlc_pc_machine_auto_district_generator_var
		}
		# Mining
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_nexus_2 }
			variable = xvcv_mdlc_pc_machine_auto_district_mining_var
		}
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_nexus_3 }
			variable = xvcv_mdlc_pc_machine_auto_district_farming_var
		}
	}
	else = {
		# should apply to nearly all standard world classes
		# Uncapped appear on hive and ringworlds
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_city }
			variable = xvcv_mdlc_pc_machine_auto_district_city_var
		}
		# Generator
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_generator }
			variable = xvcv_mdlc_pc_machine_auto_district_generator_var
		}
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_mining }
			variable = xvcv_mdlc_pc_machine_auto_district_mining_var
		}
		export_trigger_value_to_variable = {
			trigger = num_districts
			parameters = { type = district_farming }
			variable = xvcv_mdlc_pc_machine_auto_district_farming_var
		}
	}

	change_pc = xvcv_mdlc_pc_machine_auto
	if = {
		limit = { NOT = { has_modifier = planet_population_control_gestalt } }
		add_modifier = { modifier = planet_population_control_gestalt days = -1 }
	}
	subtract_variable = {
		which = xvcv_mdlc_pc_machine_auto_district_city_var
		value = 1
	}
	# ADD DISTRICTS
	if = {
		limit = { owner = { has_oxr_mdlc_origin_world_machine_awakened = yes } }
		while = {
			limit = { check_variable = { which = xvcv_mdlc_pc_machine_auto_district_city_var value > 0 } }
			subtract_variable = { which = xvcv_mdlc_pc_machine_auto_district_city_var value = 1 }
			add_district = xvcv_mdlc_pc_machine_auto_district_primary_origin_wm
		}
	}
	else = {
		while = {
			limit = { check_variable = { which = xvcv_mdlc_pc_machine_auto_district_city_var value > 0 } }
			subtract_variable = { which = xvcv_mdlc_pc_machine_auto_district_city_var value = 1 }
			add_district = xvcv_mdlc_pc_machine_auto_district_city
		}
	}

	while = {
		limit = { check_variable = { which = xvcv_mdlc_pc_machine_auto_district_generator_var value > 0 } }
		subtract_variable = { which = xvcv_mdlc_pc_machine_auto_district_generator_var value = 1 }
		add_district = xvcv_mdlc_pc_machine_auto_district_generator
	}
	while = {
		limit = { check_variable = { which = xvcv_mdlc_pc_machine_auto_district_mining_var value > 0 } }
		subtract_variable = { which = xvcv_mdlc_pc_machine_auto_district_mining_var value = 1 }
		add_district = xvcv_mdlc_pc_machine_auto_district_mining
	}
	while = {
		limit = { check_variable = { which = xvcv_mdlc_pc_machine_auto_district_farming_var value > 0 } }
		subtract_variable = { which = xvcv_mdlc_pc_machine_auto_district_farming_var value = 1 }
		add_district = xvcv_mdlc_pc_machine_auto_district_farming
	}
	clear_variable = xvcv_mdlc_pc_machine_auto_district_city_var
	clear_variable = xvcv_mdlc_pc_machine_auto_district_industrial_var
	clear_variable = xvcv_mdlc_pc_machine_auto_district_mining_var
	clear_variable = xvcv_mdlc_pc_machine_auto_district_farming_var

	xvcv_mdlc_planet_owner_terraforming_resolution_breached_effect = yes
	oxr_mdlc_planet_add_wmc_core_deposit_if_missing = yes
}

xvcv_mdlc_planet_send_message_xvcv_mdlc_pc_machine_ser_project_complete = {
	if = {
		limit = { has_country_flag = xvcv_mdlc_decision_machine_ser_project_message_on }
		create_message = {
			type = XVCV_MDLC_WORLD_MACHINES_COMPLETION_MESSAGE_TYPE
			localization = XVCV_MDLC_DECISION_MACHINE_SER_PROJECT_DONE_MESSAGE
			days = 10
			target = prev
			variable = {
				type = name
				localization = XVCV_MDLC_DECISION_MACHINE_SER_PROJECT_PLANET
				scope = prev
			}
		}
	}
}

xvcv_mdlc_planet_send_message_xvcv_mdlc_pc_machine_ecu_project_complete = {
	if = {
		limit = { has_country_flag = xvcv_mdlc_decision_machine_ecu_project_message_on }
		create_message = {
			type = XVCV_MDLC_WORLD_MACHINES_COMPLETION_MESSAGE_TYPE
			localization = XVCV_MDLC_DECISION_MACHINE_ECU_PROJECT_DONE_MESSAGE
			days = 10
			target = prev
			variable = {
				type = name
				localization = XVCV_MDLC_DECISION_MACHINE_ECU_PROJECT_PLANET
				scope = prev
			}
		}
	}
}

xvcv_mdlc_planet_send_message_xvcv_mdlc_pc_machine_cpu_project_complete = {
	owner = {
		if = {
			limit = { has_country_flag = xvcv_mdlc_decision_machine_cpu_project_message_on }
			create_message = {
				type = XVCV_MDLC_WORLD_MACHINES_COMPLETION_MESSAGE_TYPE
				localization = XVCV_MDLC_DECISION_MACHINE_CPU_PROJECT_DONE_MESSAGE
				days = 10
				target = prev
				variable = {
					type = name
					localization = XVCV_MDLC_DECISION_MACHINE_CPU_PROJECT_PLANET
					scope = prev
				}
			}
		}
	}
}

xvcv_mdlc_planet_decision_convert_to_world_machine = {
	oxr_mdlc_planet_clear_blockers_etc_if_not_already_wm = yes
	oxr_mdlc_planet_create_deposit_upgrade_flags = yes
	change_pc = $PLANET_CLASS$
	oxr_mdlc_planet_restore_deposit_upgrades = yes
	oxr_mdlc_planet_add_wmc_core_deposit_if_missing = yes
	if = {
		limit = { NOT = { has_modifier = planet_population_control_gestalt } }
		add_modifier = { modifier = planet_population_control_gestalt days = -1 }
	}

	xvcv_mdlc_planet_owner_terraforming_resolution_breached_effect = yes
	# Re-use this trigger to replace the capital with auto-capital
	if = {
		limit = { oxr_owner_has_wm_origin = yes }
		# Add info modifier
		oxr_mdlc_planet_do_wm_origin_things_after_project = yes
	}
	if = {
		limit = { oxr_mdlc_planet_is_t3_world_machine = yes }
		oxr_mdlc_planet_set_initial_cooling_district_count_var = yes
		xvcv_mdlc_planet_wm_calc_output_value = yes
	}
}

oxr_mdlc_save_planet_class_before_convert_to_wm = {
	# This is run before change_pc
	# only supports a few planet classes
	if = {
		limit = {
			is_planet_world_machine = no
		}
		if = {
			limit = {
				is_planet_class = pc_relic
				doesnt_have_planet_flag = { FLAG = oxr_mdlc_pc_was_relic }
			}
			set_planet_flag = oxr_mdlc_pc_was_relic
		}
	}
}
