namespace = oxr_mdlc_civic_consolidators

# Create the invisible country that controls the movers
event = {
	id = oxr_mdlc_civic_consolidators.1
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				NOT = {
					any_country = {
						is_country_type = oxr_mdlc_country_consolidators_movers_controller
					}
				}
			}
			create_country = {
				name = "name_oxr_mdlc_country_consolidators_movers_controller"
				type = oxr_mdlc_country_consolidators_movers_controller
				flag = {
					icon = {
						category = "special"
						file = "caravaneer_00.dds"
					}
					background = {
						category = "backgrounds"
						file = "triangle_split.dds"
					}
					colors = {
						"green"
						"dark_green"
						"null"
						"null"
					}
				}
				effect = {
					save_global_event_target_as = oxr_mdlc_country_consolidators_movers_controller_target
				}
			}
		}
	}
	
}

# on game start, flag/create consolidator dropoff points and establish comms with invisible country 
country_event = {
	# on game start
	id = oxr_mdlc_civic_consolidators.2
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_civic = oxr_mdlc_civic_consolidators
	}

	immediate = {
		if = {
			limit = {
				NOT = {
					exists = event_target:oxr_mdlc_civic_consolidation_target_@root
				}
			}
			capital_scope = {
				save_global_event_target_as = oxr_mdlc_civic_consolidation_target_@root
			}
		}
		capital_scope = {
			solar_system = {
				# Make moon for depositing resources
				# First, use an existing planetary body, if available
				if = {
					limit = {
						any_system_planet = {
							has_deposit_for = shipclass_mining_station
							is_star = no
						}
					}
					random_system_planet = {
						limit = {
							has_deposit_for = shipclass_mining_station
							is_star = no
						}
						set_planet_flag = oxr_mdlc_civic_orbital_target@root
					}
				}
				# We didn't find one with any mining deposits..
				# Look again
				else_if = {
					limit = {
						any_system_planet = {
							NOT = { has_deposit_for = shipclass_mining_station }
							NOT = { has_deposit_for = shipclass_research_station }
							is_star = no
							is_colony = no
						}
					}
					random_system_planet = {
						limit = {
							NOT = { has_deposit_for = shipclass_mining_station }
							NOT = { has_deposit_for = shipclass_research_station }
							is_star = no
							is_colony = no
						}
						set_planet_flag = oxr_mdlc_civic_orbital_target@root
					}
				}
				# No suitable targets .. snap our robo-digits and make one appear
				else = {
					spawn_planet = {
						class = pc_barren
						name = "oxr_mdlc_civic_consolidators_capital_resource_moon"
						orbit_angle = 180
						orbit_distance = 110
						size = 1
						location = prev
						orbit_location = yes
						orbit_angle_offset = 45
						orbit_distance_offset = 9.899
						has_ring = no
						init_effect = {
							add_deposit = d_minerals_1
							set_planet_flag = oxr_mdlc_civic_orbital_target@root
						}
					}
				}

				# Set up a target for research deposit dropoffs
				# First, look for a planet that has a research deposit,
				# and mark that as the dropoff for consolidated research deposits
				if = {
					limit = {
						any_system_planet = {
							has_deposit_for = shipclass_research_station
							is_star = no
						}
					}
					random_system_planet = {
						limit = {
							has_deposit_for = shipclass_research_station
							is_star = no
						}
						set_planet_flag = oxr_mdlc_civic_orbital_research_target@root
						log = "Set orbital research dropoff target to [This.GetName] (1st attempt)"
					}

				}
				# We didn't find any planets that already have a research deposit.
				# Look for one that is suitable:
				# 1 - no orbital deposits of any kind
				else_if = {
					limit = {
						any_system_planet = {
							NOT = { has_deposit_for = shipclass_mining_station }
							NOT = { has_deposit_for = shipclass_research_station }
							is_star = no
							is_colony = no
						}
					}
					random_system_planet = {
						limit = {
							NOT = { has_deposit_for = shipclass_mining_station }
							NOT = { has_deposit_for = shipclass_research_station }
							is_star = no
							is_colony = no
						}
						set_planet_flag = oxr_mdlc_civic_orbital_research_target@root
						log = "Set orbital research dropoff target to [This.GetName] (2nd attempt)"
					}
				}
				# We didn't find a suitable one .. so create one from nothing
				spawn_planet = {
					class = pc_barren
					name = "oxr_mdlc_civic_consolidators_capital_research_moon"
					orbit_angle = 180
					orbit_distance = 140
					size = 1
					location = prev
					orbit_location = yes
					orbit_angle_offset = 45
					orbit_distance_offset = 12.899
					has_ring = no
					init_effect = {
						add_deposit = d_physics_1
						set_planet_flag = oxr_mdlc_civic_orbital_research_target@root
						log = "Created orbital research dropoff target [This.GetName] (final attempt)"
					}
				}
			}
		}
		
		random_country = {
			limit = {
				is_country_type = oxr_mdlc_country_consolidators_movers_controller
				NOT = { has_communications = root }
			}
			establish_communications_no_message = root
		}
	}
}




# when consolidator mover ship arrives at target
country_event = {
	id = oxr_mdlc_civic_consolidators.2000
	hide_window = yes
	is_triggered_only = yes
	# This = owner of fleet
	# From = fleet
	# FromFrom = planet (if any)

	trigger = {
		from = {
			any_owned_ship = { is_ship_size = oxr_mdlc_civic_consolidators_ship }
		}
	}

	immediate = {
		from.solar_system = {
			random_system_planet = {
				limit = {
					has_planet_flag = oxr_mdlc_civic_orbital_target@space_owner
				}
				save_event_target_as = oxr_mdlc_civic_consolidators_target_planet
			}
		}

		## Check what resource is being transferred over
		# energy
		if = {
			limit = {
				from = {
					is_variable_set = oxr_mdlc_consolidator_ship_resource_type_energy
				}
			}
			# add 1 energy deposit per 1 value in variable
			while = {
				count = from.oxr_mdlc_consolidator_ship_resource_type_energy
				event_target:oxr_mdlc_civic_consolidators_target_planet = {
					add_deposit = d_energy_1
					# Deposit the new amount as a variable also
					set_or_increment_variable = {
						VAR = oxr_mdlc_consolidator_total_energy_deposits
						AMOUNT = 1
					}
				}
			}
			destroy_fleet = from
		}
	}
}


# planet dialogue to consolidate resources
# 'from' is the source planet
country_event = {
	id = oxr_mdlc_civic_consolidators.3000
	title = "oxr_mdlc_civic_consolidators.3000.title"
	desc = "oxr_mdlc_civic_consolidators.3000.desc"
	picture = GFX_evt_habitable_dig_site
	is_triggered_only = yes

	# energy
	option = {
		name = "oxr_mdlc_civic_consolidators.3000.option_energy"
		# find any energy deposit and convert its size into a variable
		# then set a flag on the planet saying that it is marked for consolidation
		hidden_effect = {
			log = "Planet menu picked energy deposits for processing"
			from = {
				oxr_mdlc_planet_select_orbital_energy_deposits_for_processing = yes
			}
		}
	}
	# minerals
	option = {
		name = "oxr_mdlc_civic_consolidators.3000.option_minerals"
		allow = {
			from = {
				oxr_mdlc_consolidators_planet_has_orbital_minerals_deposits = yes
				NOT = {
					has_planet_flag = oxr_mdlc_consolidators_planet_consolidation_in_progress
				}
			}
		}
		# find any energy deposit and convert its size into a variable
		# then set a flag on the planet saying that it is marked for consolidation
		hidden_effect = {
			log = "Planet menu picked energy deposits for processing"
			from = {
				oxr_mdlc_planet_select_orbital_minerals_deposits_for_processing = yes
			}
		}
		
	}
	option = {
		name = EXCELLENT
		default_hide_option = yes
	}
}

# call the mover
planet_event = {
	id = oxr_mdlc_civic_consolidators.3100
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		oxr_mdlc_country_create_mover_fleet_give_instructions = {
			RESOURCE = energy
		}
	}
}


# get the fucking event widnow to show.. wtf why is not appearing?

country_event = {
	id = oxr_mdlc_civic_consolidators.3200
	title = "oxr_mdlc_civic_consolidators.3000.title"
	desc = "oxr_mdlc_civic_consolidators.3000.desc"
	picture = GFX_evt_habitable_dig_site
	is_triggered_only = yes

	trigger = {
		space_owner = {
			has_civic = oxr_mdlc_civic_consolidators
		}
	}

	option = {
		name = EXCELLENT
		default_hide_option = yes
		hidden_effect = {
			log = "finished event 3200"
		}
	}
}